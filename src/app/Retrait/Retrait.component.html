<p-toast />
<div class="card">
  <div style="text-align: center; margin-bottom: 30px;">
    <h2 >Liste des Traites</h2>
    <p>Voici la liste des Traites effectués avec leurs détails, y compris les montants, les dates d'échéance, les entreprises associées, les fournisseurs, et les banques impliquées.</p>
  </div>
 

<div class="d-flex align-items-center justify-content-between p-2 bg-light text-dark border rounded mb-3">
  <p-menubar [model]="items" />
  
  <p-iconfield class="d-flex align-items-center">
    <p-inputicon styleClass="pi pi-search" />
    <input type="text" pInputText placeholder="Search" class="form-control" />
  </p-iconfield>
  
</div>


  


  <p-contextMenu #cm [model]="items2" [appendTo]="'body'"></p-contextMenu>

  <!-- Table -->
  <p-table 
    #dt1 
    [value]="retraitesLightData" 
    dataKey="id" 
    [rows]="10" 
    [rowsPerPageOptions]="[10, 25, 50]" 
    [loading]="loading" 
    [paginator]="true" 
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" 
    [filterDelay]="0" 
    selectionMode="single"
    [contextMenu]="cm"
    [(contextMenuSelection)]="selectedRetrait" 
    [globalFilterFields]="['numeroCheque', 'entreprise.nom']">
    


    <ng-template #header>
      <tr>
        <th style="width: 1rem">
            <p-tableHeaderCheckbox pReorderableColumn class="printable"/>
        </th>
        
        <th style="width: 15rem">
            Numéro
            <p-columnFilter type="text" field="numeroCheque" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 16rem">
            Montant
            <p-columnFilter type="numeric" field="montant" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 25rem">
            Date d'échéance
            <p-columnFilter type="date" field="dateEcheance" display="menu" class="ml-auto"/>
        </th>

        <th style="width: 25rem">
            Date Creation
            <p-columnFilter type="date" field="DateCreation" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 25rem">
            Fournisseurs
            <p-columnFilter type="text" field="fournisseurs.nom" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 25rem">
            Fournisseurs Adr
            <p-columnFilter type="text" field="fournisseurs.adresse" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 25rem">
            Banques
            <p-columnFilter type="text" field="banques.nom" display="menu" class="ml-auto"/>
        </th>
        
        <th style="width: 25rem">
            Banques Adr
            <p-columnFilter type="text" field="banques.adresse" display="menu" class="ml-auto"/>
        </th>
        
        <th>
            Voir
        </th>
    </tr>
    </ng-template>

    <ng-template #body let-ret>
      <tr style="cursor: pointer;"  [pContextMenuRow]="ret">
        <td >
          <p-tableCheckbox pReorderableRowHandle class="printable"/>
        </td>
        <td>{{ ret.numeroCheque }}</td>
        <td>{{ ret.montant | number:'1.2-2' }} TND</td>
        <td>{{ getFormattedEcheance(ret.dateEcheance) }}</td>
        <td>{{ ret.dateCreation | date:'dd/MM/yyyy ' }}</td>
          <td>
            <p-tag [severity]="'info'" [value]=" ret.fournisseurNom  || 'N/A'"></p-tag>
          </td>
          <td>{{ ret.fournisseurAdresse || 'N/A' }}</td>

          <td>
            <p-tag [severity]="'info'" [value]="ret.banqueNom || 'N/A'"></p-tag>
          </td>
          
          <td>{{ ret.banqueAdresse || 'N/A' }}</td>
        <td style="width: 7%; " (click)="NavigateToRetraiteDetails(ret)">
          <i class="pi pi-eye hover-blue" style="font-size: 1.25rem;padding-left: 8px;"  ></i>
        </td>
        
      </tr>
    </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="100%" style="text-align: center; width: 100%;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
              <iframe 
                src="https://lottie.host/embed/64172e68-0b40-4a28-8ac4-d8c506fcd7d1/1FLsCpbxo0.lottie" 
                width="200" 
                height="200" 
                frameborder="0" 
                allow="autoplay; encrypted-media" 
                allowfullscreen>
              </iframe>
              <div>Aucune Traite trouvée.</div>
            </div>
          </td>
        </tr>
      </ng-template>
    
    
  </p-table>
</div>



<p-drawer [(visible)]="AddRetraitInfo" header="Ajouter un Nouveau Traite" position="right" [style]="{width: '450px'}">
  <div class="p-4">
    <!-- Form without reactive forms -->
    <div>


      <!-- Numéro de Chèque Field -->
      <div class="mb-3">
        <label for="cheque" class="form-label" style="color: #223167;">Numéro de Traite</label>
        <input 
          type="text" 
          class="form-control" 
          id="cheque"
          #chequeInput
          [(ngModel)]="AddRetrait.NumCheque"
          placeholder="Ex: CHK123456">
        <div *ngIf="showChequeError" class="text-danger small mt-1">Le numéro de chèque est requis</div>
      </div>

      <div class="mb-4">
        <label for="echeance" class="form-label d-block mb-2">Date d'Échéance</label>
        <div class="w-100 d-block">
            <input 
            type="date" 
            class="form-control" 
            id="cheque"
            #chequeInput
            placeholder="Ex: CHK123456"
            [(ngModel)]="AddRetrait.dateEcheance"
            >
        </div>
        <div *ngIf="showDateError" class="text-danger small mt-1">
          Veuillez sélectionner une date valide
        </div>
      </div>

            <!-- Montant Field -->
            <div class="mb-3">
              <label for="montant" class="form-label">Montant (TND)</label>
              <p-inputNumber 
                id="montant" 
                #montantInput
                [(ngModel)]="AddRetrait.montant"
                mode="currency" 
                placeholder="0.00 TND" 
                currency="TND" 
                locale="fr-FR"
                [min]="0"
                class="w-100"
                inputStyleClass="form-control"
                [showButtons]="true">
              </p-inputNumber>
              <div *ngIf="showMontantError" class="text-danger small mt-1">Veuillez entrer un montant valide</div>
            </div>

            <div class="mb-3">
              <label for="fournisseur-autocomplete" class="form-label d-block mb-2">Fournisseur</label>
              <div style="display: flex;">
                             <p-autocomplete 
                id="fournisseur-autocomplete"
                inputId="fournisseur-input"
                [(ngModel)]="selectedFournisseur"
                [suggestions]="filteredFournisseurs"
                (completeMethod)="filterFournisseurs($event)"
                field="nom"
                [dropdown]="true"
                placeholder="Sélectionner un fournisseur"
                [inputStyle]="{ 'width':'100%' }"
                [scrollHeight]="'250px'"
                [panelStyle]="{ 'min-width':'300px', 'white-space':'normal' }"
                [style]="{ 'width':'100%' }"
                class="d-block w-100"
              >

            
                <!-- Full-detail item template -->
                <ng-template let-fournisseur pTemplate="item">
                  <div class="d-flex flex-column p-2" style="white-space: normal;">
                    <div><strong>{{ fournisseur.nom }}</strong></div>
                    <div class="small text-muted mt-1">
                      <i class="pi pi-phone me-1"></i>{{ fournisseur.telephone }}
                      <i class="pi pi-envelope ms-3 me-1"></i>{{ fournisseur.email }}
                    </div>
                    <div class="small text-muted mt-1">
                      <i class="pi pi-map-marker me-1"></i>{{ fournisseur.adresse }}
                    </div>
                  </div>
                </ng-template>
            
              </p-autocomplete>
              <button type="button"  pButton icon="pi pi-plus" class="p-button-rounded p-button"   severity="secondary" [text]="true" (click)="toggleAddFournisseurInfo()"></button> 
              <button type="button"  pButton icon="pi pi-eye" class="p-button-rounded p-button"   severity="secondary" [text]="true" (click)="toggleDialog()"></button> 
              </div>


            
              <div *ngIf="showFournisseurError" class="text-danger small mt-1">
                Veuillez sélectionner un fournisseur valide
              </div>
            </div>
            
            
            

            <div class="mb-3">
              <label for="bank-autocomplete" class="form-label d-block mb-2">Nom Banque</label>
              <div style="display: flex;">
              <p-autocomplete 
                id="bank-autocomplete"
                [(ngModel)]="selectedBank"
                [suggestions]="filteredBanks"
                (completeMethod)="filterBanks($event)"
                field="nom"
                [dropdown]="true"
                placeholder="Sélectionner une banque"
                [inputStyle]="{'width':'100%'}"
                [scrollHeight]="'250px'"
                [panelStyle]="{'min-width':'300px', 'white-space':'normal'}"
                [style]="{'width':'100%'}"
                class="d-block w-100">
                
                <ng-template let-bank pTemplate="item">
                  <div class="bank-item" style="white-space: normal; padding: 8px;">
                    {{bank.nom}}
                  </div>
                </ng-template>
                
              </p-autocomplete>
                  <button type="button" pButton icon="pi pi-plus" class="p-button-rounded p-button"   severity="secondary" [text]="true" (click)="toggleAddBanqueInfo()"></button>
                  <button type="button"  pButton icon="pi pi-eye" class="p-button-rounded p-button"   severity="secondary" [text]="true" (click)="toggleDialogBanque()"></button> 
              </div>


            
              <div *ngIf="showBankError" class="text-danger small mt-1">
                Veuillez sélectionner une banque valide
              </div>
            </div>
            

            








      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2 p-3 bg-light" style="position: absolute; bottom: 0; left: 0; width: 100%;">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="AddRetraitInfo = false">
          <i class="pi pi-times me-2"></i>Annuler
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="validateForm()">
          <i class="pi pi-check me-2"></i>Enregistrer
        </button>
      </div>

      
    </div>
  </div>
</p-drawer>



<p-drawer [(visible)]="AddBanqueInfo" header="Ajouter une Banque" position="right" [style]="{width: '450px'}">
  <div class="p-4 d-flex flex-column" style="height: 100%; position: relative;">
    <!-- Formulaire -->
    <div style="flex-grow: 1; overflow-y: auto; padding-bottom: 60px;"> 
      
      <!-- Nom de la banque -->
      <div class="mb-3">
        <label class="form-label">Nom de la Banque</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="banque.nom"
          name="banqueNom"
          placeholder="Ex: Banque Nationale">
        <div *ngIf="showNomBanqueError" class="text-danger small mt-1">
          Le nom de la banque est requis
        </div>
      </div>

      <!-- Adresse de la banque -->
      <div class="mb-3">
        <label class="form-label">Adresse</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="banque.adresse"
          name="banqueAdresse"
          placeholder="Ex: 12 Rue de Paris, 75000 Paris, France">
        <div *ngIf="showAdresseError" class="text-danger small mt-1">
          L'adresse est requise
        </div>
      </div>

      <!-- RIB -->
      <div class="mb-3">
        <label class="form-label">RIB</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="banque.rib"
          name="banqueRIB"
          placeholder="Ex: 12345678912345678912">
        <div *ngIf="showRibError" class="text-danger small mt-1">
          Le RIB est requis
        </div>
      </div>

    </div>

    <!-- Boutons d'action -->
    <div class="d-flex justify-content-end gap-2 p-3 bg-light" style="position: absolute; bottom: 0; left: 0; width: 100%;">
      <button type="button" class="btn btn-outline-secondary" (click)="AddBanqueInfo = false">
        <i class="pi pi-times me-2"></i>Annuler
      </button>
      <button type="button" class="btn btn-primary" (click)="onSaveBanque()">
        <i class="pi pi-check me-2"></i>Enregistrer
      </button>
    </div>
  </div>
</p-drawer>




<p-drawer [(visible)]="AddFournisseurInfo" header="Ajouter un Nouveau Fournisseur" position="right" [style]="{width: '450px'}">
  <div class="p-4">
    <div>
      <div class="mb-3">
        <label class="form-label">Nom du Fournisseur</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="FournisseurAjouter.nom"
          name="fournisseurNom"
          placeholder="Ex: Société ABC">
        <div class="text-danger small mt-1" *ngIf="showFournisseurErrors.nom">
          Le nom du fournisseur est requis
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Email du Fournisseur</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="FournisseurAjouter.email"
          name="fournisseurEmail"
          placeholder="Ex: contact@abc.com">
        <div class="text-danger small mt-1" *ngIf="showFournisseurErrors.email">
          L'email du fournisseur est requis
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Téléphone du Fournisseur</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="FournisseurAjouter.telephone"
          name="fournisseurTelephone"
          placeholder="Ex: +216 99 999 999">
        <div class="text-danger small mt-1" *ngIf="showFournisseurErrors.telephone">
          Le téléphone du fournisseur est requis
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Adresse du Fournisseur</label>
        <input 
          type="text" 
          class="form-control"
          [(ngModel)]="FournisseurAjouter.adresse"
          name="fournisseurAdresse"
          placeholder="Ex: 12 Rue de Tunis">
        <div class="text-danger small mt-1" *ngIf="showFournisseurErrors.adresse">
          L'adresse du fournisseur est requise
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2 p-3 bg-light" style="position: absolute; bottom: 0; left: 0; width: 100%;">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="AddFournisseurInfo = false">
          <i class="pi pi-times me-2"></i>Annuler
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="onSaveFournisseur()">
          <i class="pi pi-check me-2"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</p-drawer>


<p-dialog
  header="Liste des Fournisseurs"
  [resizable]="false"
  [modal]="true"
  [maximizable]="true"
  appendTo="body"
  [(visible)]="dialogVisible"
  [style]="{ width: '75vw' }"
  [contentStyle]="{ height: '300px' }"
>
  <p-table
    #dt
    [value]="fournisseursData"
    dataKey="id"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [loading]="loading"
    [paginator]="true"
    [scrollable]="true"
    scrollHeight="flex"
    [tableStyle]="{ 'min-width': '55rem' }"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [filterDelay]="0"
    [globalFilterFields]="['nom', 'email', 'telephone', 'adresse']"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 15rem">
          Nom
          <p-columnFilter type="text" field="nom" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 20rem">
          Email
          <p-columnFilter type="text" field="email" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 15rem">
          Téléphone
          <p-columnFilter type="text" field="telephone" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 25rem">
          Adresse
          <p-columnFilter type="text" field="adresse" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 10rem">Outils</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-fournisseur>
      <tr>
        <td>{{ fournisseur.nom }}</td>
        <td>{{ fournisseur.email }}</td>
        <td>{{ fournisseur.telephone }}</td>
        <td>{{ fournisseur.adresse }}</td>
        <td>
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-sm p-button-rounded p-button-text p-button-secondary"
            title="Modifier"
          ></button>
          <button
            pButton
            icon="pi pi-trash"
            class="p-button-sm p-button-rounded p-button-text p-button-danger"
            (click)="confirmDeleteFournisseur(fournisseur);"
            title="Supprimer"
          ></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="100%" style="text-align: center; width: 100%;">
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
            <iframe
              src="https://lottie.host/embed/9001f2fe-ee47-47a4-bc9b-a4f3899d0d13/CoC7Gm9nvK.lottie"
              width="200"
              height="200"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen>
            </iframe>
            <div>Aucun Fournisseur trouvé.</div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  
  <ng-template pTemplate="footer">
    <p-button label="Fermer" icon="pi pi-times" (onClick)="dialogVisible = false" />
  </ng-template>
</p-dialog>

<p-dialog
  header="Liste des Banques"
  [resizable]="false"
  [modal]="true"
  [maximizable]="true"
  appendTo="body"
  [(visible)]="dialogVisibleBanque"
  [style]="{ width: '75vw' }"
  [contentStyle]="{ height: '300px' }"
>
  <p-table
    #dtBanque
    [value]="banquesData"
    dataKey="id"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [paginator]="true"
    [scrollable]="true"
    scrollHeight="flex"
    [tableStyle]="{ 'min-width': '60rem' }"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [filterDelay]="0"
    [globalFilterFields]="['nom', 'adresses.rue', 'adresses.ville', 'adresses.pays']"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 20rem">
          Nom
          <p-columnFilter type="text" field="nom" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 45rem">
          Adresses
          <p-columnFilter type="text" field="adresses.ville" display="menu" class="ml-auto"/>
        </th>
        <th style="width: 10rem">Outils</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-banque>
      <tr>
        <td>{{ banque.nom }}</td>
<td>
  <div class="d-flex flex-column gap-1">
    <div class="small text-secondary border-start ps-2">
      {{ banque?.adresse }}
    </div>
  </div>
</td>

        <td>
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-sm p-button-rounded p-button-text p-button-secondary"
            title="Modifier"
          ></button>
          <button
            pButton
            icon="pi pi-trash"
            class="p-button-sm p-button-rounded p-button-text p-button-danger"
            (click)="confirmDeleteBanque(banque);"
            title="Supprimer"
          ></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="100%" style="text-align: center; width: 100%;">
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
            <iframe
              src="https://lottie.host/embed/9001f2fe-ee47-47a4-bc9b-a4f3899d0d13/CoC7Gm9nvK.lottie"
              width="200"
              height="200"
              frameborder="0"
              allow="autoplay; encrypted-media"
              allowfullscreen>
            </iframe>
            <div>Aucune Banque trouvée.</div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  
  <ng-template pTemplate="footer">
    <p-button label="Fermer" icon="pi pi-times" (onClick)="dialogVisibleBanque = false" />
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>